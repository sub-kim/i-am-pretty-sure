<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ğŸ‡°ğŸ‡· Google Trend Search_daily</title>
    <style>
        :root { --bg:#0b1020; --fg:#e8ecff; --muted:#a7b0d9; --card:#121838; --accent:#6aa2ff; }
        html,body { margin:0; height:100%; background:var(--bg); color:var(--fg); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        header { display:flex; gap:12px; align-items:center; padding:16px 20px; position:sticky; top:0; background:linear-gradient(180deg,var(--bg),rgba(11,16,32,0.85)); backdrop-filter: blur(6px); }
        h1 { font-size:18px; margin:0; }
        .meta { color:var(--muted); font-size:13px; margin-left:auto; display:flex; gap:12px; align-items:center; }
        .pill { border:1px solid #26305a; padding:2px 8px; border-radius:999px; }
        .btn { cursor:pointer; border:1px solid #2b3a75; background:#19214a; color:var(--fg); border-radius:10px; padding:6px 10px; font-size:13px; }
        main { padding: 12px 16px 80px; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
        .card { background:var(--card); border:1px solid #202a55; border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:8px; }
        .rank { font-weight:700; font-size:12px; color:#9db6ff; }
        .title a { color:var(--fg); text-decoration:none; font-weight:700; }
        .title a:hover { color:var(--accent); }
        .traffic { font-size:12px; color:var(--muted); }
        .news { border-top:1px dashed #2b3666; margin-top:8px; padding-top:8px; display:flex; flex-direction:column; gap:6px; }
        .news a { color:#b9c7ff; text-decoration:none; font-size:13px; }
        .news a:hover { text-decoration:underline; }
        footer { position:fixed; bottom:0; left:0; right:0; color:var(--muted); background:linear-gradient(0deg,var(--bg),rgba(11,16,32,0.85)); backdrop-filter: blur(6px); padding:10px 16px; font-size:12px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #1a2247; }
    </style>
</head>
<body>
<header>
    <h1>ğŸ‡°ğŸ‡· Google Trend Search_daily</h1>
    <div class="meta">
        <span id="updated" class="pill">ì—…ë°ì´íŠ¸: -</span>
        <span id="countdown" class="pill">ë‹¤ìŒ ê°±ì‹ : 60s</span>
        <button id="refreshBtn" class="btn">ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨</button>
        <span id="mode" class="pill" style="cursor:pointer" title="í´ë¦­í•´ì„œ ì›¹/ë‰´ìŠ¤ ì „í™˜">ë§í¬: ì›¹ê²€ìƒ‰</span>
    </div>
</header>

<main id="grid" aria-live="polite"></main>

<footer>
    <div>ë°ì´í„°: Google Trends RSS(KR). ì‹¤ì‹œê°„ì´ ì•„ë‹Œ â€œì¼ë³„ ê¸‰ìƒìŠ¹â€ ê¸°ì¤€ì…ë‹ˆë‹¤.</div>
    <div><a href="https://trends.google.co.kr/trends/trendingsearches/daily?geo=KR" target="_blank" rel="noopener">ì›ë³¸ ì—´ê¸°</a></div>
</footer>

<script>
    // 1ì°¨: AllOrigins â†’ google.com
    const RSS_GOOGLE_COM = 'https://trends.google.com/trends/trendingsearches/daily/rss?geo=KR';
    // 2ì°¨: AllOrigins â†’ google.co.kr
    const RSS_GOOGLE_KR  = 'https://trends.google.co.kr/trends/trendingsearches/daily/rss?geo=KR';
    // 3ì°¨: r.jina.ai (ë°˜ë“œì‹œ httpsâ†’https í˜•ì‹ ì‚¬ìš©)
    const RSS_JINA_AI    = 'https://r.jina.ai/https://trends.google.com/trends/trendingsearches/daily/rss?geo=KR';

    // (ì„ íƒ) ë„¤ê°€ ì§ì ‘ ë°°í¬í•œ Worker. ì‹¤ì œ URLë¡œ ë°”ê¾¸ì§€ ì•Šìœ¼ë©´ 404 ë‚©ë‹ˆë‹¤.
    const PROXY_URL      = ''; // ì˜ˆ: 'https://trends-kr.<ë‚´ì„œë¸Œë„ë©”ì¸>.workers.dev'

    const grid = document.getElementById('grid');
    const updatedEl = document.getElementById('updated');
    const countdownEl = document.getElementById('countdown');
    const refreshBtn = document.getElementById('refreshBtn');

    function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // AllOrigins raw ì—”ë“œí¬ì¸íŠ¸ ë˜í¼
    const ao = (url) => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);

    // ë§í¬ ëª¨ë“œ: 'web' | 'news'
    let linkMode = 'web';
    const modeEl = document.getElementById('mode');
    if (modeEl) {
        modeEl.addEventListener('click', () => {
            linkMode = (linkMode === 'web') ? 'news' : 'web';
            modeEl.textContent = `ë§í¬: ${linkMode === 'web' ? 'ì›¹ê²€ìƒ‰' : 'ë‰´ìŠ¤'}`;
            // í™”ë©´ë§Œ ë‹¤ì‹œ ê·¸ë¦´ í•„ìš”ê°€ ìˆìœ¼ë©´ refresh ëˆŒëŸ¬ë„ ë˜ê³  ê·¸ëŒ€ë¡œ ë‘¬ë„ OK
        });
    }

    function buildSearchLink(title) {
        const q = encodeURIComponent(title || '');
        if (linkMode === 'news') {
            // ë‰´ìŠ¤ íƒ­
            return `https://www.google.com/search?tbm=nws&hl=ko&gl=kr&pws=0&q=${q}`;
        }
        // ì¼ë°˜ ì›¹ê²€ìƒ‰
        return `https://www.google.com/search?hl=ko&gl=kr&pws=0&q=${q}`;
    }

    async function fetchText(url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);
        const t = await res.text();
        console.log('[Trends] Fetched', url, 'len=', t.length, 'head=', t.slice(0, 200));
        return t;
    }

    function parseRssToItems(xmlText) {
        const xml = new DOMParser().parseFromString(xmlText, 'text/xml');
        const items = [...xml.querySelectorAll('item')].map((item) => {
            const text = (sel) => item.querySelector(sel)?.textContent?.trim() || '';
            const stripCdata = (s) => s.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g, '');
            const title  = stripCdata(text('title'));
            const link   = text('link');
            const approx = stripCdata(item.querySelector('ht\\:approx_traffic')?.textContent || '');
            const news = [...item.querySelectorAll('ht\\:news_item')].map(n => ({
                title:  stripCdata(n.querySelector('ht\\:news_item_title')?.textContent || ''),
                source: stripCdata(n.querySelector('ht\\:news_item_source')?.textContent || ''),
                url:    (n.querySelector('ht\\:news_item_url')?.textContent || '')
            }));
            return { title, link, approxTraffic: approx, news };
        });
        return { updatedAt: new Date().toISOString(), items };
    }

    // âœ… ì‹ í˜• RSS í”¼ë“œ (ì§€ì—­ë³„)
    const FEED_NEW       = 'https://trends.google.com/trending/rss?geo=KR';
    // 1ì°¨: AllOrigins í†µí•´ CORS í—ˆìš©
    const AO_FEED        = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(FEED_NEW);
    // 2ì°¨: r.jina.ai í´ë°±
    const JINA_FEED      = 'https://r.jina.ai/' + FEED_NEW.replace('https://', 'https://');

    // ìˆœì°¨ í´ë°±: AllOrigins(ì‹ í˜•URL) â†’ r.jina.ai(ì‹ í˜•URL) â†’ (ìˆë‹¤ë©´) ë„¤ Worker
    async function fetchTrendsSmart() {
        const errors = [];
        for (const url of [AO_FEED, JINA_FEED]) {
            try {
                const xml = await fetchText(url);
                const data = parseRssToItems(xml);
                if (data.items.length) return data;
                errors.push(`${url}: item=0`);
            } catch (e) {
                errors.push(`${url}: ${e.message}`);
            }
        }

        if (PROXY_URL) {
            try {
                const res = await fetch(PROXY_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status} @ ${PROXY_URL}`);
                return await res.json();
            } catch (e) {
                errors.push(`PROXY ${PROXY_URL}: ${e.message}`);
            }
        }

        throw new Error(errors.join(' | '));
    }

    function render({ updatedAt, items }) {
        updatedEl.textContent = `ì—…ë°ì´íŠ¸: ${new Date(updatedAt).toLocaleString()}`;
        if (!items.length) {
            grid.innerHTML = `<div style="grid-column:1/-1; color:#ffdf9a">
        í•­ëª©ì´ 0ê±´ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, PROXY_URL(ì§ì ‘ ë°°í¬ Worker)ì„ ì„¤ì •í•˜ì„¸ìš”.
      </div>`;
            return;
        }
        grid.innerHTML = items.map((it, idx) => `
      <article class="card">
        <div class="rank">#${idx+1}</div>
        <div class="title"><a href="${buildSearchLink(it.title)}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a></div>
        ${it.approxTraffic ? `<div class="traffic">ëŒ€ëµ íŠ¸ë˜í”½: ${escapeHtml(it.approxTraffic)}</div>` : ''}
        ${it.news?.length ? `
          <div class="news">
            ${it.news.slice(0,3).map(n => `<a href="${n.url}" target="_blank" rel="noopener">ğŸ“° ${escapeHtml(n.title)} <small>(${escapeHtml(n.source)})</small></a>`).join('')}
          </div>` : ''}
      </article>
    `).join('');
    }

    let remain = 60;
    async function load() {
        try {
            const data = await fetchTrendsSmart();
            render(data);
        } catch (e) {
            const isFile = location.protocol === 'file:';
            const tips = [
                `ì˜¤ë¥˜: ${escapeHtml(e.message)}`,
                isFile ? 'í˜„ì¬ file:// ë¡œ ì—´ë ¤ ìˆì–´ originì´ null ì…ë‹ˆë‹¤.' : `í˜„ì¬ origin: ${location.origin}`,
                'í•´ê²° íŒ:',
                ' - ê°€ì¥ ê°„ë‹¨: ë¡œì»¬ ì„œë²„ë¡œ ì—´ê¸° (python -m http.server 5500)',
                ' - AllOriginsê°€ 503ì´ë©´ ì ì‹œ í›„ ì¬ì‹œë„',
                ' - ì•ˆì • ìš´ìš©: PROXY_URLì„ ì§ì ‘ ë°°í¬í•œ Worker ì£¼ì†Œë¡œ ì„¤ì •(ì•„ë˜ ì°¸ê³ )',
            ];
            grid.innerHTML = `<div style="grid-column:1/-1; white-space:pre-line; color:#ff9aa2">${tips.join('\n')}</div>`;
        }
    }

    function tick() {
        remain--;
        if (remain <= 0) { remain = 60; load(); }
        countdownEl.textContent = `ë‹¤ìŒ ê°±ì‹ : ${remain}s`;
    }

    document.getElementById('refreshBtn').addEventListener('click', () => { remain = 60; load(); });
    load();
    setInterval(tick, 1000);
</script>
</body>
</html>